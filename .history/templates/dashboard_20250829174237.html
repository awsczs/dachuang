<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>新能源电站数据可视化</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.0/papaparse.min.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f8f9fa;
            color: #333;
        }
        .dashboard-header {
            background: linear-gradient(135deg, #1a936f 0%, #88d498 100%);
            color: white;
            padding: 1.5rem 0;
            margin-bottom: 2rem;
            border-radius: 0 0 10px 10px;
        }
        .card {
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            margin-bottom: 1.5rem;
            border: none;
        }
        .card-header {
            background-color: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
            font-weight: 600;
        }
        .stats-card {
            text-align: center;
            padding: 1.5rem;
            transition: transform 0.3s;
        }
        .stats-card:hover {
            transform: translateY(-5px);
        }
        .stats-value {
            font-size: 2rem;
            font-weight: 700;
            color: #1a936f;
        }
        .stats-label {
            color: #6c757d;
            font-size: 0.9rem;
        }
        .chart-container {
            position: relative;
            height: 400px;
            margin-bottom: 20px;
        }
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        .spinner-border {
            width: 3rem;
            height: 3rem;
            color: #1a936f;
        }
        .btn-primary {
            background-color: #1a936f;
            border-color: #176e54;
        }
        .btn-primary:hover {
            background-color: #176e54;
            border-color: #12523f;
        }
        .control-panel {
            background-color: white;
            padding: 1.5rem;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            margin-bottom: 1.5rem;
        }
        .power-plant-selector {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        .power-plant-btn {
            flex: 1;
            padding: 12px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            background-color: #f8f9fa;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }
        .power-plant-btn:hover {
            background-color: #e9ecef;
        }
        .power-plant-btn.active {
            border-color: #1a936f;
            background-color: rgba(26, 147, 111, 0.1);
            color: #1a936f;
            font-weight: 600;
        }
        .power-plant-btn i {
            font-size: 24px;
            margin-bottom: 8px;
            display: block;
        }
    </style>
</head>
<body>
    <!-- 顶部标题区域 -->
    <div class="dashboard-header">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h1><i class="bi bi-lightning-charge"></i> 新能源电站数据可视化</h1>
                    <p class="lead">实时监控与分析电站发电情况</p>
                </div>
                <div class="col-md-4 text-md-end">
                    <div id="currentTime" class="fw-light"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="container">
        <!-- 电站选择器 -->
        <div class="power-plant-selector">
            <div class="power-plant-btn active" data-plant="xinyue" onclick="selectPowerPlant('xinyue')">
                <i class="bi bi-sun"></i>
                <div>新乐凤鸣光伏电站</div>
            </div>
            <div class="power-plant-btn" data-plant="julu" onclick="selectPowerPlant('julu')">
                <i class="bi bi-wind"></i>
                <div>巨鹿腾煌风电场站</div>
            </div>
        </div>

        <!-- 控制面板 -->
        <div class="control-panel">
            <div class="row">
                <div class="col-md-4 mb-3">
                    <label for="startDate" class="form-label">开始日期</label>
                    <input type="date" class="form-control" id="startDate">
                </div>
                <div class="col-md-4 mb-3">
                    <label for="endDate" class="form-label">结束日期</label>
                    <input type="date" class="form-control" id="endDate">
                </div>
                <div class="col-md-4 mb-3">
                    <label for="dataGranularity" class="form-label">数据粒度</label>
                    <select class="form-select" id="dataGranularity">
                        <option value="raw">原始数据</option>
                        <option value="hourly">小时平均</option>
                        <option value="daily">日平均</option>
                    </select>
                </div>
            </div>
            <div class="row">
                <div class="col-md-8 mb-3">
                    <label for="csvFile" class="form-label">选择数据文件</label>
                    <input class="form-control" type="file" id="csvFile" accept=".csv">
                </div>
                <div class="col-md-4 d-flex align-items-end mb-3">
                    <button class="btn btn-primary w-100" onclick="loadData()">加载数据</button>
                </div>
            </div>
        </div>

        <!-- 数据概览 -->
        <div class="row">
            <div class="col-md-3">
                <div class="card stats-card">
                    <div class="stats-value" id="totalRecords">0</div>
                    <div class="stats-label">总数据记录数</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stats-card">
                    <div class="stats-value" id="avgPredicted">0</div>
                    <div class="stats-label">平均预测功率 (kW)</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stats-card">
                    <div class="stats-value" id="avgActual">0</div>
                    <div class="stats-label">平均实际功率 (kW)</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stats-card">
                    <div class="stats-value" id="efficiency">0%</div>
                    <div class="stats-label">发电效率</div>
                </div>
            </div>
        </div>

        <!-- 图表区域 -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <span id="chartTitle">功率曲线</span>
                        <small id="dateRange" class="text-muted">选择日期范围后加载数据</small>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="powerChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 数据表格 -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        详细数据
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover" id="dataTable">
                                <thead>
                                    <tr>
                                        <th>时间戳</th>
                                        <th>预测功率 (kW)</th>
                                        <th>实际功率 (kW)</th>
                                        <th>差异 (kW)</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- 数据将通过JavaScript填充 -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 加载指示器 -->
    <div class="loading-overlay" id="loadingIndicator" style="display: none;">
        <div class="text-center">
            <div class="spinner-border" role="status"></div>
            <p class="mt-2">正在加载数据，请稍候...</p>
        </div>
    </div>

    <script>
        // 全局变量
        let currentData = null;
        let powerChart = null;
        let selectedPlant = 'xinyue'; // 默认选择新乐凤鸣光伏电站
        
        // 选择电站
        function selectPowerPlant(plant) {
            selectedPlant = plant;
            
            // 更新UI显示
            document.querySelectorAll('.power-plant-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`.power-plant-btn[data-plant="${plant}"]`).classList.add('active');
            
            // 更新标题
            const plantName = plant === 'xinyue' ? '新乐凤鸣光伏电站' : '巨鹿腾煌风电场站';
            document.getElementById('chartTitle').textContent = `${plantName} - 功率曲线`;
            document.querySelector('h1').innerHTML = `<i class="bi bi-lightning-charge"></i> ${plantName}数据可视化`;
            
            // 如果有数据，重新渲染图表
            if (currentData) {
                renderCharts(currentData);
            }
        }
        
        // 初始化日期选择器为最近7天
        function initDatePickers() {
            const endDate = new Date();
            const startDate = new Date();
            startDate.setDate(endDate.getDate() - 7);
            
            document.getElementById('startDate').valueAsDate = startDate;
            document.getElementById('endDate').valueAsDate = endDate;
            
            // 更新当前时间
            updateCurrentTime();
            setInterval(updateCurrentTime, 1000);
        }
        
        function updateCurrentTime() {
            const now = new Date();
            document.getElementById('currentTime').textContent = now.toLocaleString('zh-CN');
        }
        
        // 加载数据函数
        function loadData() {
            showLoading(true);
            
            const fileInput = document.getElementById('csvFile');
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            const granularity = document.getElementById('dataGranularity').value;
            
            if (!fileInput.files.length) {
                alert('请先选择CSV文件');
                showLoading(false);
                return;
            }
            
            const file = fileInput.files[0];
            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    // 使用PapaParse解析CSV
                    const csvData = e.target.result;
                    const parsedData = Papa.parse(csvData, {
                        header: true,
                        dynamicTyping: true,
                        skipEmptyLines: true
                    });
                    
                    // 处理解析后的数据
                    processData(parsedData.data, startDate, endDate, granularity);
                } catch (error) {
                    console.error('解析CSV时出错:', error);
                    alert('解析CSV文件时出错: ' + error.message);
                    showLoading(false);
                }
            };
            
            reader.onerror = function() {
                alert('读取文件时出错');
                showLoading(false);
            };
            
            reader.readAsText(file);
        }
        
        // 处理数据
        function processData(data, startDate, endDate, granularity) {
            // 转换时间戳并过滤数据
            const filteredData = data.filter(item => {
                if (!item.timeStamp) return false;
                
                const itemDate = new Date(item.timeStamp);
                const start = new Date(startDate);
                const end = new Date(endDate);
                end.setHours(23, 59, 59, 999); // 包含结束日期的全天
                
                return itemDate >= start && itemDate <= end;
            });
            
            // 根据粒度聚合数据
            let processedData = filteredData;
            if (granularity === 'hourly') {
                processedData = aggregateDataHourly(filteredData);
            } else if (granularity === 'daily') {
                processedData = aggregateDataDaily(filteredData);
            }
            
            // 更新全局数据
            currentData = {
                timestamps: processedData.map(d => d.timeStamp),
                predicted_power: processedData.map(d => d.pred || 0),
                actual_power: processedData.map(d => d.power || 0),
                time_range: {
                    start: startDate,
                    end: endDate
                }
            };
            
            // 更新UI
            updateStats(currentData);
            renderCharts(currentData);
            renderDataTable(currentData);
            showLoading(false);
            
            // 更新数据概览信息
            document.getElementById('dateRange').textContent = `${startDate} 至 ${endDate}`;
            document.getElementById('totalRecords').textContent = currentData.timestamps.length;
        }
        
        // 按小时聚合数据
        function aggregateDataHourly(data) {
            const aggregated = {};
            
            data.forEach(item => {
                if (!item.timeStamp) return;
                
                const date = new Date(item.timeStamp);
                // 创建小时键（忽略分钟和秒）
                const hourKey = new Date(date.getFullYear(), date.getMonth(), date.getDate(), date.getHours()).toISOString();
                
                if (!aggregated[hourKey]) {
                    aggregated[hourKey] = {
                        timeStamp: hourKey,
                        pred: 0,
                        power: 0,
                        count: 0
                    };
                }
                
                aggregated[hourKey].pred += item.pred || 0;
                aggregated[hourKey].power += item.power || 0;
                aggregated[hourKey].count++;
            });
            
            // 计算平均值
            return Object.values(aggregated).map(item => ({
                timeStamp: item.timeStamp,
                pred: Math.round(item.pred / item.count),
                power: Math.round(item.power / item.count)
            }));
        }
        
        // 按日聚合数据
        function aggregateDataDaily(data) {
            const aggregated = {};
            
            data.forEach(item => {
                if (!item.timeStamp) return;
                
                const date = new Date(item.timeStamp);
                // 创建日期键（忽略时间）
                const dayKey = new Date(date.getFullYear(), date.getMonth(), date.getDate()).toISOString();
                
                if (!aggregated[dayKey]) {
                    aggregated[dayKey] = {
                        timeStamp: dayKey,
                        pred: 0,
                        power: 0,
                        count: 0
                    };
                }
                
                aggregated[dayKey].pred += item.pred || 0;
                aggregated[dayKey].power += item.power || 0;
                aggregated[dayKey].count++;
            });
            
            // 计算平均值
            return Object.values(aggregated).map(item => ({
                timeStamp: item.timeStamp,
                pred: Math.round(item.pred / item.count),
                power: Math.round(item.power / item.count)
            }));
        }
        
        // 更新统计信息
        function updateStats(data) {
            const predAvg = data.predicted_power.reduce((a, b) => a + b, 0) / data.predicted_power.length;
            const actualAvg = data.actual_power.reduce((a, b) => a + b, 0) / data.actual_power.length;
            const efficiency = actualAvg / predAvg * 100;
            
            document.getElementById('avgPredicted').textContent = Math.round(predAvg);
            document.getElementById('avgActual').textContent = Math.round(actualAvg);
            document.getElementById('efficiency').textContent = Math.round(efficiency) + '%';
        }
        
        // 渲染图表
        function renderCharts(data) {
            const ctx = document.getElementById('powerChart').getContext('2d');
            
            // 销毁现有图表（如果存在）
            if (powerChart) {
                powerChart.destroy();
            }
            
            // 格式化时间标签
            const labels = data.timestamps.map(ts => {
                const date = new Date(ts);
                return date.toLocaleString('zh-CN', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            });
            
            // 创建新图表
            powerChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: '预测功率',
                            data: data.predicted_power,
                            borderColor: 'rgba(75, 192, 192, 1)',
                            backgroundColor: 'rgba(75, 192, 192, 0.2)',
                            borderWidth: 2,
                            fill: true,
                            tension: 0.1
                        },
                        {
                            label: '实际功率',
                            data: data.actual_power,
                            borderColor: 'rgba(255, 99, 132, 1)',
                            backgroundColor: 'rgba(255, 99, 132, 0.2)',
                            borderWidth: 2,
                            fill: true,
                            tension: 0.1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: '预测功率 vs 实际功率',
                            font: {
                                size: 16
                            }
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false
                        },
                        legend: {
                            position: 'top',
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: '时间'
                            },
                            ticks: {
                                maxTicksLimit: 10,
                                autoSkip: true,
                                maxRotation: 45
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: '功率 (kW)'
                            },
                            beginAtZero: true
                        }
                    }
                }
            });
        }
        
        // 渲染数据表格
        function renderDataTable(data) {
            const tableBody = document.querySelector('#dataTable tbody');
            tableBody.innerHTML = '';
            
            // 只显示前100条记录以避免性能问题
            const displayCount = Math.min(data.timestamps.length, 100);
            
            for (let i = 0; i < displayCount; i++) {
                const tr = document.createElement('tr');
                
                const timestamp = new Date(data.timestamps[i]).toLocaleString('zh-CN');
                const pred = data.predicted_power[i];
                const actual = data.actual_power[i];
                const diff = actual - pred;
                
                // 根据差异值设置颜色
                let diffClass = '';
                if (diff > 0) {
                    diffClass = 'text-success';
                } else if (diff < 0) {
                    diffClass = 'text-danger';
                }
                
                tr.innerHTML = `
                    <td>${timestamp}</td>
                    <td>${pred}</td>
                    <td>${actual}</td>
                    <td class="${diffClass}">${diff > 0 ? '+' : ''}${diff}</td>
                `;
                
                tableBody.appendChild(tr);
            }
            
            // 添加提示信息（如果数据被截断）
            if (data.timestamps.length > 100) {
                const tr = document.createElement('tr');
                tr.innerHTML = `<td colspan="4" class="text-center text-muted">仅显示前100条记录，共${data.timestamps.length}条记录</td>`;
                tableBody.appendChild(tr);
            }
        }
        
        // 显示/隐藏加载指示器
        function showLoading(show) {
            document.getElementById('loadingIndicator').style.display = show ? 'flex' : 'none';
        }
        
        // 初始化
        document.addEventListener('DOMContentLoaded', function() {
            initDatePickers();
            // 默认选择新乐凤鸣光伏电站
            selectPowerPlant('xinyue');
        });
    </script>
</body>
</html>